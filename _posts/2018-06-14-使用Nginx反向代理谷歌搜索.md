---
layout: post
---
## 1 ä»€ä¹ˆæ˜¯ä»£ç†

åœ¨è®¡ç®—æœºç½‘ç»œåŸºç¡€è®¾æ–½æ¶æ„ä¸­ï¼Œä»£ç†(Proxy)æ˜¯åœ¨å®¢æˆ·ç«¯(Client)ä¸æœåŠ¡å™¨(Server)ä¹‹é—´çš„æœåŠ¡ä¸è®¾æ–½ã€‚ä»£ç†ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼Œå¾…æœåŠ¡å™¨è¿”å›ç»“æœåï¼Œä»£ç†å°†ç»“æœè½¬å‘ç»™å®¢æˆ·ç«¯ï¼Œå¯ä»¥ç†è§£ä¸ºä¸­é—´äººã€‚

## 2 ä¾èµ–

- ä¸€å°å¯ä»¥è®¿é—®[è°·æ­Œæœç´¢](https://google.com)çš„ä¸»æœºï¼Œå¯ä»¥åœ¨å„å¤§ä¸»æœºæä¾›å•†è´­ä¹°
- Nginxç¨‹åº

## 3 å®‰è£…Nginx

## 4 å®‰è£…Nginx

### 4.1 å®‰è£…å¼€å‘å¥—ä»¶

æ‰§è¡Œå‘½ä»¤ï¼š

```bash
$ sudo apt-get install build-essential libtool
```

### 4.2 å®‰è£…PCRE

```bash
$ sudo wget -O /usr/local/src/pcre-8.41.zip https://ftp.pcre.org/pub/pcre/pcre-8.41.zip
$ cd /usr/local/src
$ sudo unzip pcre-8.41.zip
$ cd pcre-8.41
$ sudo ./configure
$ sudo make
$ sudo make install
```

### 4.3 å®‰è£…zlib

```bash
$ sudo wget -O /usr/local/src/zlib-1.2.11.tar.gz https://zlib.net/zlib-1.2.11.tar.gz
$ cd /usr/local/src
$ sudo tar zxf zlib-1.2.11.tar.gz
$ cd zlib-1.2.11
$ sudo ./configure
$ sudo make
$ sudo make install
```

### 4.4 å®‰è£…OpenSSL

```bash
$ sudo wget -O /usr/local/src/openssl-1.1.0f.tar.gz https://www.openssl.org/source/openssl-1.1.0f.tar.gz
$ cd /usr/local/src
$ sudo tar zxf openssl-1.1.0f.tar.gz
$ cd openssl-1.1.0f
$ sudo ./config
$ sudo make
$ sudo make install
```

### 4.5 ä¸‹è½½ngx_http_substitutions_filteræ’ä»¶æºä»£ç 

```bash
$ sudo wget -O /usr/local/src/master.zip https://github.com/yaoweibin/ngx_http_substitutions_filter_module/archive/master.zip
$ cd /usr/local/src
$ sudo unzip master.zip
```

### 4.6 å®‰è£…Nginx

```bash
$ sudo wget -O /usr/local/nginx-1.13.5.tar.gz http://nginx.org/download/nginx-1.13.5.tar.gz
$ cd /usr/local/src
$ sudo tar zxf nginx-1.13.5.tar.gz
$ cd nginx-1.13.5
$ sudo ./configure --sbin-path=/usr/local/nginx/nginx \
--conf-path=/usr/local/nginx/nginx.conf \
--pid-path=/usr/local/nginx/nginx.pid \
--with-http_ssl_module \
--with-pcre=/usr/local/src/pcre-8.41 \
--with-http_stub_status_module \
--with-http_gzip_static_module \
--with-zlib=/usr/local/src/zlib-1.2.11 \
--with-openssl=/usr/local/src/openssl-1.1.0f \
--add-module=/usr/local/src/ngx_http_substitutions_filter_module-master
$ sudo sudo make
$ sudo sudo make install
```

è‹¥ä»¥ä¸Šè¿‡ç¨‹æˆåŠŸå®Œæˆï¼Œè¯·è¯•è¿è¡Œnginxï¼š

```bash
$ sudo /usr/local/nginx/nginx
```

### 4.7 å¼€æ”¾80ç«¯å£

> æ­¤å¤„æ¼”ç¤ºå¦‚ä½•è®¾ç½®é˜²ç«å¢™å…è®¸å¤–ç•Œè®¿é—®80ç«¯å£

æ‰§è¡Œå‘½ä»¤ï¼š

```
$ sudo ufw allow 80
```

> è‹¥ä½¿ç”¨é˜¿é‡Œäº‘ECSï¼Œå› ä¸ºå…¶â€å®‰å…¨ç»„â€è®¾ç½®ä½œç”¨å’Œé˜²ç«å¢™ç±»ä¼¼ï¼Œè¯·å‚è€ƒå…¶æ–‡æ¡£ï¼›

è®¿é—®ä¸»æœºçš„80ç«¯å£ï¼Œè‹¥å‡ºç°æ¬¢è¿ç•Œé¢ï¼Œåˆ™å®‰è£…æˆåŠŸï¼Œè‹¥å¤±è´¥ï¼Œè¯·å°è¯•æ’é™¤é”™è¯¯ã€‚

## 5 ç¼–è¾‘Nginxè™šæ‹Ÿä¸»æœº

ç¼–è¾‘Nginxé…ç½®æ–‡ä»¶ï¼Œè‹¥æŒ‰ç…§ä¸Šé¢çš„å®‰è£…è¿‡ç¨‹ï¼Œé…ç½®æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¸º`/usr/local/nginx/nginx.conf`ï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ä¿®æ”¹è¯¥æ–‡ä»¶ï¼Œè®¾ç½®ç›‘å¬80ç«¯å£çš„è™šæ‹Ÿä¸»æœºï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```conf
server {

	listen 80;
	server_name $ä¸»æœºIPæˆ–è€…åŸŸå;
	#å˜é‡ï¼Œä»£ç†åŸŸå
	set $proxy_hostname www.google.com;

	location / {
		#ä»£ç†è®¾ç½®
		proxy_cookie_domain $proxy_hostname $server_name;
		proxy_pass https://$proxy_hostname;
		proxy_ssl_name $proxy_hostname;
		#è®¾å®šè½¬å‘åç«¯æœåŠ¡å™¨çš„header
		proxy_set_header Host $proxy_hostname;
		proxy_set_header User-Agent $http_user_agent;
		proxy_set_header Referer http://$proxy_hostname;
		proxy_set_header X-Real_IP $remote_addr;
		#è°·æ­Œæœç´¢å“åº”é¡µé¢ä¸è¢«å‹ç¼©ï¼Œä½¿å¾—æ›¿æ¢æ’ä»¶èƒ½å¤Ÿå·¥ä½œ
		proxy_set_header Accept-Encoding "";
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;
		proxy_set_header Cookie "";
		proxy_set_header referer https://$proxy_hostname$request_uri;
		#æ›¿æ¢è°·æ­Œæœç´¢åŸŸåä¸ºå½“å‰ä¸»æœºåç§°
		subs_filter https://$proxy_hostname http://$server_name g;
		#æ¶ˆé™¤æ¡Œé¢ç‰ˆé¡µé¢çš„è·Ÿè¸ª
		subs_filter ping=\"(.+?)\" '' ir;
		subs_filter oncontextmenu=\"google.ctpacw.cm(this)\" '' ir;
		#æ›¿æ¢æ–‡ä»¶ç±»å‹
		subs_filter_types text/css text/xml text/javascript;
	}
}
```

é‡å¯nginxï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```bash
$ sudo /usr/local/nginx/nginx -s reload
```

ä½¿ç”¨æµè§ˆå™¨è®¿é—®ä½ çš„åŸŸåï¼Œè‹¥æˆåŠŸå“åº”è°·æ­Œæœç´¢é¡µé¢ï¼Œåˆ™è®¾ç½®æˆåŠŸã€‚

å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ¥ä¿¡å“¦ğŸ“¨ï¸ï½
