<!doctype html><html><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>
基于Nginx的反向代理
</title>
<meta name=generator content="Hugo 0.91.2">
<link rel=stylesheet href="https://zenuo.github.io/css/styles.min.da6e1927bcb6a0faebcb06ab9925c87524b8057860afacf48eab54fcbf9eef18.css" integrity="sha256-2m4ZJ7y2oPrrywarmSXIdSS4BXhgr6z0jqtU/L+e7xg=">
<script async defer data-domain=kaiwern.com src=https://plausible.io/js/plausible.js></script>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora&family=Source+Sans+Pro:wght@400;600&display=swap" rel=stylesheet>
<body class="flex flex-col min-h-screen px-6 max-w-prose md:w-2/3 m-auto"><nav class=mt-8>
<ul id=nav-menu class="w-full flex items-center list-reset">
<li>
<a href=https://zenuo.github.io/>Home</a>
</li>
<li>
<a href=https://zenuo.github.io/fragments/>Fragments</a>
</li>
<li>
<a href=https://zenuo.github.io/about/>About</a>
</li>
<li>
<a href=https://zenuo.github.io/tags/>Tags</a>
</li>
</ul>
</nav>
<main class="flex-1 mt-10 sm:mt-12">
<div>
<header class="mb-8 font-sans-serif">
<div class="text-sm font-gray-700 mb-8">
<p class="uppercase font-semibold">
<a class=text-gray-700 href=/fragments>fragments</a>
</p>
<p>Jun 03, 2019</p>
</div>
<h1 class="text-3xl mb-1 font-semibold">基于Nginx的反向代理</h1>
<p class="italic text-xs">Last updated at: Jun 03, 2019</p>
</header>
<article class="prose serif mb-16 text-gray-800">
<p>配置文件如下：</p>
<pre tabindex=0><code class=language-conf data-lang=conf>user  www;
worker_processes  1;

pid        logs/nginx.pid;

events {
    worker_connections  1024;
    use epoll;
}

http {

    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$google&quot;';

    access_log  logs/access.log  main;

    access_log off;
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 5M;
    client_body_buffer_size 256K;
    types_hash_max_size 2048;

    #设定DNS
    resolver [2001:4860:4860::8888] [2001:4860:4860::8844];
    sendfile        on;
    tcp_nopush     on;
    keepalive_timeout  65;
    gzip  on;
    proxy_connect_timeout    5;
    proxy_read_timeout       60;
    proxy_send_timeout       5;
    proxy_buffer_size        16k;
    proxy_buffers            4 64k;
    proxy_busy_buffers_size 128k;
    #proxy_temp_file_write_size 128k;
    #proxy_temp_path   /var/nginx_cache/temp;
    #设定缓存的路径和其他参数，http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path
    #proxy_cache_path  /var/nginx_cache/cache levels=1:2 keys_zone=one:16m inactive=1d max_size=512m;

    #设定复用SSL会话
    proxy_ssl_session_reuse on;
    proxy_redirect off;
    proxy_ssl_server_name on;
    #缓存key规则，用于自动清除缓存
    proxy_cache_key $scheme://$host$request_uri;
    #缓存区名称，设定于proxy_cache_path
    #proxy_cache one;
    #200 304状态缓存3小时
    proxy_cache_valid 200 304 10m;
    #301状态缓存3天
    proxy_cache_valid 301 3d;
    #其他状态缓存（如502 404）1分钟
    proxy_cache_valid any 0s;
    #当后端出现错误、超时、502状态时启用过期缓存
    proxy_cache_use_stale invalid_header error timeout http_502;

    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:AES128+EECDH:AES128+EDH:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;
    ssl_session_cache shared:SSL:10m;
    add_header Strict-Transport-Security max-age=63072000;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    # 勾勾
    upstream gogo {
        server 127.0.0.1:4999;
    }

    server {
        listen 5000 ssl;
        server_name 176.122.157.73;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
                proxy_pass http://gogo;
                #proxy_pass https://176.122.157.73:5001;
        }
    }


    #桌面版中文维基
    server {
    listen 3457 ssl;
    server_name 176.122.157.73;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
                #proxy_cache one;
                proxy_pass https://zh.wikipedia.org; 
                proxy_buffering off;
                proxy_cookie_domain zh.wikipedia.org $server_name:$server_port;
                proxy_redirect https://zh.wikipedia.org/ /;
                proxy_redirect https://zh.m.wikipedia.org/ https://$server_name:3458/;
                proxy_set_header X-Real_IP $remote_addr;
                proxy_set_header User-Agent $http_user_agent;
                proxy_set_header Accept-Encoding &quot;&quot;;
                proxy_set_header referer &quot;https://zh.wikipedia.org$request_uri&quot;;

                #替换手机版视图为代理
                subs_filter zh.m.wikipedia.org $server_name:3458 g;
                subs_filter zh.wikipedia.org $server_name:$server_port g;
                subs_filter en.m.wikipedia.org $server_name:5005 g;
                subs_filter en.wikipedia.org $server_name:5004 g;
        }

        location https://zh.m.wikipedia.org/ {
                rewrite ^/(.*) https://$server_name:3458/$1 permanent;
        }
    }

    #移动版中文维基
    server {
        listen 3458 ssl;
        server_name 176.122.157.73;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
            #proxy_cache one;
            proxy_pass https://zh.m.wikipedia.org;
            proxy_buffering off;
            proxy_redirect https://zh.m.wikipedia.org/ /;
            proxy_cookie_domain zh.m.wikipedia.org $server_name:$server_port;

            proxy_set_header X-Real_IP $remote_addr;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Accept-Encoding &quot;&quot;;
            proxy_set_header referer https://zh.m.wikipedia.org$request_uri;

                #替换桌面版视图为代理
            subs_filter zh.wikipedia.org $server_name:3457 g;
            subs_filter zh.m.wikipedia.org $server_name:$server_port g;
            subs_filter en.m.wikipedia.org $server_name:5005 g;
            subs_filter en.wikipedia.org $server_name:5004 g;
        }
    }

    #谷歌搜索
    server {
        listen 5001 ssl;
        server_name 176.122.157.73;

        set $google &quot;&quot;;
        rewrite_by_lua '
                        local googles = {
                                &quot;www.google.is&quot;,
                                &quot;www.google.dk&quot;,
                                &quot;www.google.no&quot;,
                                &quot;www.google.se&quot;,
                                &quot;www.google.fi&quot;,
                                &quot;www.google.ee&quot;,
                                &quot;www.google.lv&quot;,
                                &quot;www.google.lt&quot;,
                                &quot;www.google.ie&quot;,
                                &quot;www.google.co.uk&quot;,
                                &quot;www.google.gg&quot;,
                                &quot;www.google.je&quot;,
                                &quot;www.google.im&quot;,
                                &quot;www.google.fr&quot;,
                                &quot;www.google.nl&quot;,
                                &quot;www.google.be&quot;,
                                &quot;www.google.lu&quot;,
                                &quot;www.google.de&quot;,
                                &quot;www.google.at&quot;,
                                &quot;www.google.ch&quot;,
                                &quot;www.google.li&quot;,
                                &quot;www.google.pt&quot;,
                                &quot;www.google.es&quot;,
                                &quot;www.google.com.gi&quot;,
                                &quot;www.google.ad&quot;,
                                &quot;www.google.it&quot;,
                                &quot;www.google.com.mt&quot;,
                                &quot;www.google.sm&quot;,
                                &quot;www.google.gr&quot;,
                                &quot;www.google.ru&quot;,
                                &quot;www.google.com.by&quot;,
                                &quot;www.google.com.ua&quot;,
                                &quot;www.google.pl&quot;,
                                &quot;www.google.cz&quot;,
                                &quot;www.google.sk&quot;,
                                &quot;www.google.hu&quot;,
                                &quot;www.google.si&quot;,
                                &quot;www.google.hr&quot;,
                                &quot;www.google.ba&quot;,
                                &quot;www.google.me&quot;,
                                &quot;www.google.rs&quot;,
                                &quot;www.google.mk&quot;,
                                &quot;www.google.bg&quot;,
                                &quot;www.google.ro&quot;,
                                &quot;www.google.md&quot;,
                                &quot;www.google.mn&quot;,
                                &quot;www.google.co.kr&quot;,
                                &quot;www.google.co.jp&quot;,
                                &quot;www.google.com.vn&quot;,
                                &quot;www.google.la&quot;,
                                &quot;www.google.com.kh&quot;,
                                &quot;www.google.co.th&quot;,
                                &quot;www.google.com.my&quot;,
                                &quot;www.google.com.sg&quot;,
                                &quot;www.google.com.bn&quot;,
                                &quot;www.google.com.ph&quot;,
                                &quot;www.google.co.id&quot;,
                                &quot;www.google.kz&quot;,
                                &quot;www.google.kg&quot;,
                                &quot;www.google.com.tj&quot;,
                                &quot;www.google.co.uz&quot;,
                                &quot;www.google.tm&quot;,
                                &quot;www.google.com.af&quot;,
                                &quot;www.google.com.pk&quot;,
                                &quot;www.google.com.np&quot;,
                                &quot;www.google.co.in&quot;,
                                &quot;www.google.com.bd&quot;,
                                &quot;www.google.lk&quot;,
                                &quot;www.google.mv&quot;,
                                &quot;www.google.com.kw&quot;,
                                &quot;www.google.com.sa&quot;,
                                &quot;www.google.com.bh&quot;,
                                &quot;www.google.ae&quot;,
                                &quot;www.google.com.om&quot;,
                                &quot;www.google.jo&quot;,
                                &quot;www.google.co.il&quot;,
                                &quot;www.google.com.lb&quot;,
                                &quot;www.google.com.tr&quot;,
                                &quot;www.google.az&quot;,
                                &quot;www.google.am&quot;,
                                &quot;www.google.co.ls&quot;,
                                &quot;www.google.com.eg&quot;,
                                &quot;www.google.com.ly&quot;,
                                &quot;www.google.dz&quot;,
                                &quot;www.google.co.ma&quot;,
                                &quot;www.google.sn&quot;,
                                &quot;www.google.gm&quot;,
                                &quot;www.google.ml&quot;,
                                &quot;www.google.bf&quot;,
                                &quot;www.google.com.sl&quot;,
                                &quot;www.google.ci&quot;,
                                &quot;www.google.com.gh&quot;,
                                &quot;www.google.tg&quot;,
                                &quot;www.google.bj&quot;,
                                &quot;www.google.ne&quot;,
                                &quot;www.google.com.ng&quot;,
                                &quot;www.google.sh&quot;,
                                &quot;www.google.cm&quot;,
                                &quot;www.google.td&quot;,
                                &quot;www.google.cf&quot;,
                                &quot;www.google.ga&quot;,
                                &quot;www.google.cg&quot;,
                                &quot;www.google.cd&quot;,
                                &quot;www.google.it.ao&quot;,
                                &quot;www.google.com.et&quot;,
                                &quot;www.google.dj&quot;,
                                &quot;www.google.co.ke&quot;,
                                &quot;www.google.co.ug&quot;,
                                &quot;www.google.co.tz&quot;,
                                &quot;www.google.rw&quot;,
                                &quot;www.google.bi&quot;,
                                &quot;www.google.mw&quot;,
                                &quot;www.google.co.mz&quot;,
                                &quot;www.google.mg&quot;,
                                &quot;www.google.sc&quot;,
                                &quot;www.google.mu&quot;,
                                &quot;www.google.co.zm&quot;,
                                &quot;www.google.co.zw&quot;,
                                &quot;www.google.co.bw&quot;,
                                &quot;www.google.com.na&quot;,
                                &quot;www.google.co.za&quot;,
                                &quot;www.google.com.au&quot;,
                                &quot;www.google.com.nf&quot;,
                                &quot;www.google.co.nz&quot;,
                                &quot;www.google.com.sb&quot;,
                                &quot;www.google.com.fj&quot;,
                                &quot;www.google.fm&quot;,
                                &quot;www.google.ki&quot;,
                                &quot;www.google.nr&quot;,
                                &quot;www.google.tk&quot;,
                                &quot;www.google.ws&quot;,
                                &quot;www.google.as&quot;,
                                &quot;www.google.to&quot;,
                                &quot;www.google.nu&quot;,
                                &quot;www.google.co.ck&quot;,
                                &quot;www.google.com.do&quot;,
                                &quot;www.google.tt&quot;,
                                &quot;www.google.com.co&quot;,
                                &quot;www.google.com.ec&quot;,
                                &quot;www.google.co.ve&quot;,
                                &quot;www.google.gy&quot;,
                                &quot;www.google.com.pe&quot;,
                                &quot;www.google.com.bo&quot;,
                                &quot;www.google.com.py&quot;,
                                &quot;www.google.com.br&quot;,
                                &quot;www.google.com.uy&quot;,
                                &quot;www.google.com.ar&quot;,
                                &quot;www.google.cl&quot;,
                                &quot;www.google.gl&quot;,
                                &quot;www.google.ca&quot;,
                                &quot;www.google.com&quot;,
                                &quot;www.google.com.mx&quot;,
                                &quot;www.google.com.gt&quot;,
                                &quot;www.google.com.bz&quot;,
                                &quot;www.google.com.sv&quot;,
                                &quot;www.google.hn&quot;,
                                &quot;www.google.com.ni&quot;,
                                &quot;www.google.co.cr&quot;,
                                &quot;www.google.com.pa&quot;,
                                &quot;www.google.bs&quot;,
                                &quot;www.google.com.cu&quot;,
                                &quot;www.google.com.jm&quot;,
                                &quot;www.google.ht&quot;}
                        ngx.var.google = googles[ math.random( #googles )]';

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
            #代理设置
            proxy_cookie_domain $google $server_name;
            proxy_pass https://$google;
            proxy_ssl_name $google;
            #设定转发后端服务器的header
            proxy_set_header Host $google;
            proxy_set_header User-Agent $http_user_agent;
            #proxy_set_header User-Agent &quot;Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920)&quot;;
            proxy_set_header Referer https://$google;
            proxy_set_header X-Real_IP $remote_addr;
            proxy_set_header Accept-Encoding &quot;&quot;;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            #重定向
            proxy_redirect https://$google Https://$server_name:$server_port;
            #设定语言为大陆中文
            proxy_set_header Accept-Language &quot;zh-CN&quot;;
            proxy_set_header referer https://$google$request_uri;
            #去除跟踪
            subs_filter ping=\&quot;(.+?)\&quot; '' ir;
            subs_filter oncontextmenu=\&quot;google.ctpacw.cm\(this\)\&quot; '' ir;
            subs_filter onmousedown=\&quot;(.+?)\&quot; '' ir;

            #去除定位消息
            subs_filter &quot;&lt;div class=\&quot;smiUbb(.*?)&lt;\/div&gt;&quot; '' ir;
            #替换中文维基为代理
            subs_filter zh.wikipedia.org $server_name:3457 g;
            subs_filter zh.m.wikipedia.org $server_name:3458 g;
            subs_filter en.m.wikipedia.org $server_name:5005 g;
            subs_filter en.wikipedia.org $server_name:5004 g;
            #替换Logo链接
            subs_filter $google $server_name:$server_port g;
            subs_filter www.google.com $server_name:$server_port g;
            #替换文件类型
            subs_filter_types text/css text/xml text/javascript;
        }
    }

    #桌面版英文维基
    server {
        listen 5004 ssl;
        server_name 176.122.157.73;
        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;
        location / {
                #proxy_cache one;
                proxy_pass https://en.wikipedia.org;
                proxy_buffering off;
                proxy_cookie_domain en.wikipedia.org $server_name:$server_port;
                proxy_redirect https://en.wikipedia.org/ /;
                proxy_redirect https://en.m.wikipedia.org/ https://$server_name:5005/;
                proxy_set_header X-Real_IP $remote_addr;
                proxy_set_header User-Agent $http_user_agent;
                proxy_set_header Accept-Encoding &quot;&quot;;
                proxy_set_header referer &quot;https://en.wikipedia.org$request_uri&quot;;
                #替换手机版视图为代理
                subs_filter en.m.wikipedia.org $server_name:5005 g;
                subs_filter en.wikipedia.org $server_name:$server_port g;
                subs_filter zh.wikipedia.org $server_name:3457 g;
                subs_filter zh.m.wikipedia.org $server_name:3458 g;
        }
        location https://en.m.wikipedia.org/ {
                rewrite ^/(.*) https://$server_name:5005/$1 permanent;
        }
    }

    #移动版英文维基
    server {
        listen 5005 ssl;
        server_name 176.122.157.73;
        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
            #proxy_cache one;
            proxy_pass https://en.m.wikipedia.org;
            proxy_buffering off;
            proxy_redirect https://en.m.wikipedia.org/ /;
            proxy_cookie_domain en.m.wikipedia.org $server_name:$server_port;
            proxy_set_header X-Real_IP $remote_addr;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Accept-Encoding &quot;&quot;;
            proxy_set_header referer https://en.m.wikipedia.org$request_uri;
            #替换桌面版视图为代理
            subs_filter en.wikipedia.org $server_name:5004 g;
            subs_filter en.m.wikipedia.org $server_name:$server_port g;
            subs_filter zh.wikipedia.org $server_name:3457 g;
            subs_filter zh.m.wikipedia.org $server_name:3458 g;
        }
    }

    # v2ray
    server {
        listen 53514 ssl;
        server_name 176.122.157.73;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location /9a00db84-636e-4653-b763-e0271e167b41 {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:53513;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection &quot;upgrade&quot;;
            proxy_set_header Host $http_host;

            # Show realip in v2ray access.log
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
</code></pre>
<div class="float-right mb-8">
<p class="text-sm mb-4 font-gray-700 italic">(773 words)</p>
</div>
</article>
</div>
</main>
<hr>
<footer class="w-full text-center p-4 pin-b text-xs text-gray-400">
<p>made with <a href=https://gohugo.io class="underline hover:text-blue-400">Hugo</a> and <a href=https://tailwindcss.com class="underline hover:text-blue-400">TailwindCSS</a></p>
</footer>
</body>
</html>