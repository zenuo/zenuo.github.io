<!doctype html><html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>基于Nginx的反向代理</title><meta name=generator content="Hugo 0.112.3"><link rel=stylesheet href="https://zenuo.github.io/css/styles.min.da6e1927bcb6a0faebcb06ab9925c87524b8057860afacf48eab54fcbf9eef18.css" integrity="sha256-2m4ZJ7y2oPrrywarmSXIdSS4BXhgr6z0jqtU/L+e7xg="><script async defer data-domain=kaiwern.com src=https://plausible.io/js/plausible.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Lora&family=Source+Sans+Pro:wght@400;600&display=swap" rel=stylesheet><body class="flex flex-col min-h-screen px-6 max-w-prose md:w-2/3 m-auto"><nav class=mt-8><ul id=nav-menu class="w-full flex items-center list-reset"><li><a href=https://zenuo.github.io/>Home</a></li><li><a href=https://zenuo.github.io/fragments/>Fragments</a></li><li><a href=https://zenuo.github.io/about/>Home</a></li><li><a href=https://zenuo.github.io/tags/>Tags</a></li></ul></nav><main class="flex-1 mt-10 sm:mt-12"><div><header class="mb-8 font-sans-serif"><div class="text-sm font-gray-700 mb-8"><p class="uppercase font-semibold"><a class=text-gray-700 href=/fragments>fragments</a></p><p>Jun 03, 2019</p></div><h1 class="text-3xl mb-1 font-semibold">基于Nginx的反向代理</h1><p class="italic text-xs">Last updated at: Jun 03, 2019</p></header><article class="prose serif mb-16 text-gray-800"><p>配置文件如下：</p><pre tabindex=0><code class=language-conf data-lang=conf>user  www;
worker_processes  1;

pid        logs/nginx.pid;

events {
    worker_connections  1024;
    use epoll;
}

http {

    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                      &#39;&#34;$http_user_agent&#34; &#34;$google&#34;&#39;;

    access_log  logs/access.log  main;

    access_log off;
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 5M;
    client_body_buffer_size 256K;
    types_hash_max_size 2048;

    #设定DNS
    resolver [2001:4860:4860::8888] [2001:4860:4860::8844];
    sendfile        on;
    tcp_nopush     on;
    keepalive_timeout  65;
    gzip  on;
    proxy_connect_timeout    5;
    proxy_read_timeout       60;
    proxy_send_timeout       5;
    proxy_buffer_size        16k;
    proxy_buffers            4 64k;
    proxy_busy_buffers_size 128k;
    #proxy_temp_file_write_size 128k;
    #proxy_temp_path   /var/nginx_cache/temp;
    #设定缓存的路径和其他参数，http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path
    #proxy_cache_path  /var/nginx_cache/cache levels=1:2 keys_zone=one:16m inactive=1d max_size=512m;

    #设定复用SSL会话
    proxy_ssl_session_reuse on;
    proxy_redirect off;
    proxy_ssl_server_name on;
    #缓存key规则，用于自动清除缓存
    proxy_cache_key $scheme://$host$request_uri;
    #缓存区名称，设定于proxy_cache_path
    #proxy_cache one;
    #200 304状态缓存3小时
    proxy_cache_valid 200 304 10m;
    #301状态缓存3天
    proxy_cache_valid 301 3d;
    #其他状态缓存（如502 404）1分钟
    proxy_cache_valid any 0s;
    #当后端出现错误、超时、502状态时启用过期缓存
    proxy_cache_use_stale invalid_header error timeout http_502;

    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:AES128+EECDH:AES128+EDH:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;
    ssl_session_cache shared:SSL:10m;
    add_header Strict-Transport-Security max-age=63072000;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    # 勾勾
    upstream gogo {
        server 127.0.0.1:4999;
    }

    server {
        listen 5000 ssl;
        server_name 176.122.157.73;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
                proxy_pass http://gogo;
                #proxy_pass https://176.122.157.73:5001;
        }
    }


    #桌面版中文维基
    server {
    listen 3457 ssl;
    server_name 176.122.157.73;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
                #proxy_cache one;
                proxy_pass https://zh.wikipedia.org; 
                proxy_buffering off;
                proxy_cookie_domain zh.wikipedia.org $server_name:$server_port;
                proxy_redirect https://zh.wikipedia.org/ /;
                proxy_redirect https://zh.m.wikipedia.org/ https://$server_name:3458/;
                proxy_set_header X-Real_IP $remote_addr;
                proxy_set_header User-Agent $http_user_agent;
                proxy_set_header Accept-Encoding &#34;&#34;;
                proxy_set_header referer &#34;https://zh.wikipedia.org$request_uri&#34;;

                #替换手机版视图为代理
                subs_filter zh.m.wikipedia.org $server_name:3458 g;
                subs_filter zh.wikipedia.org $server_name:$server_port g;
                subs_filter en.m.wikipedia.org $server_name:5005 g;
                subs_filter en.wikipedia.org $server_name:5004 g;
        }

        location https://zh.m.wikipedia.org/ {
                rewrite ^/(.*) https://$server_name:3458/$1 permanent;
        }
    }

    #移动版中文维基
    server {
        listen 3458 ssl;
        server_name 176.122.157.73;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
            #proxy_cache one;
            proxy_pass https://zh.m.wikipedia.org;
            proxy_buffering off;
            proxy_redirect https://zh.m.wikipedia.org/ /;
            proxy_cookie_domain zh.m.wikipedia.org $server_name:$server_port;

            proxy_set_header X-Real_IP $remote_addr;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Accept-Encoding &#34;&#34;;
            proxy_set_header referer https://zh.m.wikipedia.org$request_uri;

                #替换桌面版视图为代理
            subs_filter zh.wikipedia.org $server_name:3457 g;
            subs_filter zh.m.wikipedia.org $server_name:$server_port g;
            subs_filter en.m.wikipedia.org $server_name:5005 g;
            subs_filter en.wikipedia.org $server_name:5004 g;
        }
    }

    #谷歌搜索
    server {
        listen 5001 ssl;
        server_name 176.122.157.73;

        set $google &#34;&#34;;
        rewrite_by_lua &#39;
                        local googles = {
                                &#34;www.google.is&#34;,
                                &#34;www.google.dk&#34;,
                                &#34;www.google.no&#34;,
                                &#34;www.google.se&#34;,
                                &#34;www.google.fi&#34;,
                                &#34;www.google.ee&#34;,
                                &#34;www.google.lv&#34;,
                                &#34;www.google.lt&#34;,
                                &#34;www.google.ie&#34;,
                                &#34;www.google.co.uk&#34;,
                                &#34;www.google.gg&#34;,
                                &#34;www.google.je&#34;,
                                &#34;www.google.im&#34;,
                                &#34;www.google.fr&#34;,
                                &#34;www.google.nl&#34;,
                                &#34;www.google.be&#34;,
                                &#34;www.google.lu&#34;,
                                &#34;www.google.de&#34;,
                                &#34;www.google.at&#34;,
                                &#34;www.google.ch&#34;,
                                &#34;www.google.li&#34;,
                                &#34;www.google.pt&#34;,
                                &#34;www.google.es&#34;,
                                &#34;www.google.com.gi&#34;,
                                &#34;www.google.ad&#34;,
                                &#34;www.google.it&#34;,
                                &#34;www.google.com.mt&#34;,
                                &#34;www.google.sm&#34;,
                                &#34;www.google.gr&#34;,
                                &#34;www.google.ru&#34;,
                                &#34;www.google.com.by&#34;,
                                &#34;www.google.com.ua&#34;,
                                &#34;www.google.pl&#34;,
                                &#34;www.google.cz&#34;,
                                &#34;www.google.sk&#34;,
                                &#34;www.google.hu&#34;,
                                &#34;www.google.si&#34;,
                                &#34;www.google.hr&#34;,
                                &#34;www.google.ba&#34;,
                                &#34;www.google.me&#34;,
                                &#34;www.google.rs&#34;,
                                &#34;www.google.mk&#34;,
                                &#34;www.google.bg&#34;,
                                &#34;www.google.ro&#34;,
                                &#34;www.google.md&#34;,
                                &#34;www.google.mn&#34;,
                                &#34;www.google.co.kr&#34;,
                                &#34;www.google.co.jp&#34;,
                                &#34;www.google.com.vn&#34;,
                                &#34;www.google.la&#34;,
                                &#34;www.google.com.kh&#34;,
                                &#34;www.google.co.th&#34;,
                                &#34;www.google.com.my&#34;,
                                &#34;www.google.com.sg&#34;,
                                &#34;www.google.com.bn&#34;,
                                &#34;www.google.com.ph&#34;,
                                &#34;www.google.co.id&#34;,
                                &#34;www.google.kz&#34;,
                                &#34;www.google.kg&#34;,
                                &#34;www.google.com.tj&#34;,
                                &#34;www.google.co.uz&#34;,
                                &#34;www.google.tm&#34;,
                                &#34;www.google.com.af&#34;,
                                &#34;www.google.com.pk&#34;,
                                &#34;www.google.com.np&#34;,
                                &#34;www.google.co.in&#34;,
                                &#34;www.google.com.bd&#34;,
                                &#34;www.google.lk&#34;,
                                &#34;www.google.mv&#34;,
                                &#34;www.google.com.kw&#34;,
                                &#34;www.google.com.sa&#34;,
                                &#34;www.google.com.bh&#34;,
                                &#34;www.google.ae&#34;,
                                &#34;www.google.com.om&#34;,
                                &#34;www.google.jo&#34;,
                                &#34;www.google.co.il&#34;,
                                &#34;www.google.com.lb&#34;,
                                &#34;www.google.com.tr&#34;,
                                &#34;www.google.az&#34;,
                                &#34;www.google.am&#34;,
                                &#34;www.google.co.ls&#34;,
                                &#34;www.google.com.eg&#34;,
                                &#34;www.google.com.ly&#34;,
                                &#34;www.google.dz&#34;,
                                &#34;www.google.co.ma&#34;,
                                &#34;www.google.sn&#34;,
                                &#34;www.google.gm&#34;,
                                &#34;www.google.ml&#34;,
                                &#34;www.google.bf&#34;,
                                &#34;www.google.com.sl&#34;,
                                &#34;www.google.ci&#34;,
                                &#34;www.google.com.gh&#34;,
                                &#34;www.google.tg&#34;,
                                &#34;www.google.bj&#34;,
                                &#34;www.google.ne&#34;,
                                &#34;www.google.com.ng&#34;,
                                &#34;www.google.sh&#34;,
                                &#34;www.google.cm&#34;,
                                &#34;www.google.td&#34;,
                                &#34;www.google.cf&#34;,
                                &#34;www.google.ga&#34;,
                                &#34;www.google.cg&#34;,
                                &#34;www.google.cd&#34;,
                                &#34;www.google.it.ao&#34;,
                                &#34;www.google.com.et&#34;,
                                &#34;www.google.dj&#34;,
                                &#34;www.google.co.ke&#34;,
                                &#34;www.google.co.ug&#34;,
                                &#34;www.google.co.tz&#34;,
                                &#34;www.google.rw&#34;,
                                &#34;www.google.bi&#34;,
                                &#34;www.google.mw&#34;,
                                &#34;www.google.co.mz&#34;,
                                &#34;www.google.mg&#34;,
                                &#34;www.google.sc&#34;,
                                &#34;www.google.mu&#34;,
                                &#34;www.google.co.zm&#34;,
                                &#34;www.google.co.zw&#34;,
                                &#34;www.google.co.bw&#34;,
                                &#34;www.google.com.na&#34;,
                                &#34;www.google.co.za&#34;,
                                &#34;www.google.com.au&#34;,
                                &#34;www.google.com.nf&#34;,
                                &#34;www.google.co.nz&#34;,
                                &#34;www.google.com.sb&#34;,
                                &#34;www.google.com.fj&#34;,
                                &#34;www.google.fm&#34;,
                                &#34;www.google.ki&#34;,
                                &#34;www.google.nr&#34;,
                                &#34;www.google.tk&#34;,
                                &#34;www.google.ws&#34;,
                                &#34;www.google.as&#34;,
                                &#34;www.google.to&#34;,
                                &#34;www.google.nu&#34;,
                                &#34;www.google.co.ck&#34;,
                                &#34;www.google.com.do&#34;,
                                &#34;www.google.tt&#34;,
                                &#34;www.google.com.co&#34;,
                                &#34;www.google.com.ec&#34;,
                                &#34;www.google.co.ve&#34;,
                                &#34;www.google.gy&#34;,
                                &#34;www.google.com.pe&#34;,
                                &#34;www.google.com.bo&#34;,
                                &#34;www.google.com.py&#34;,
                                &#34;www.google.com.br&#34;,
                                &#34;www.google.com.uy&#34;,
                                &#34;www.google.com.ar&#34;,
                                &#34;www.google.cl&#34;,
                                &#34;www.google.gl&#34;,
                                &#34;www.google.ca&#34;,
                                &#34;www.google.com&#34;,
                                &#34;www.google.com.mx&#34;,
                                &#34;www.google.com.gt&#34;,
                                &#34;www.google.com.bz&#34;,
                                &#34;www.google.com.sv&#34;,
                                &#34;www.google.hn&#34;,
                                &#34;www.google.com.ni&#34;,
                                &#34;www.google.co.cr&#34;,
                                &#34;www.google.com.pa&#34;,
                                &#34;www.google.bs&#34;,
                                &#34;www.google.com.cu&#34;,
                                &#34;www.google.com.jm&#34;,
                                &#34;www.google.ht&#34;}
                        ngx.var.google = googles[ math.random( #googles )]&#39;;

        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
            #代理设置
            proxy_cookie_domain $google $server_name;
            proxy_pass https://$google;
            proxy_ssl_name $google;
            #设定转发后端服务器的header
            proxy_set_header Host $google;
            proxy_set_header User-Agent $http_user_agent;
            #proxy_set_header User-Agent &#34;Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920)&#34;;
            proxy_set_header Referer https://$google;
            proxy_set_header X-Real_IP $remote_addr;
            proxy_set_header Accept-Encoding &#34;&#34;;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            #重定向
            proxy_redirect https://$google Https://$server_name:$server_port;
            #设定语言为大陆中文
            proxy_set_header Accept-Language &#34;zh-CN&#34;;
            proxy_set_header referer https://$google$request_uri;
            #去除跟踪
            subs_filter ping=\&#34;(.+?)\&#34; &#39;&#39; ir;
            subs_filter oncontextmenu=\&#34;google.ctpacw.cm\(this\)\&#34; &#39;&#39; ir;
            subs_filter onmousedown=\&#34;(.+?)\&#34; &#39;&#39; ir;

            #去除定位消息
            subs_filter &#34;&lt;div class=\&#34;smiUbb(.*?)&lt;\/div&gt;&#34; &#39;&#39; ir;
            #替换中文维基为代理
            subs_filter zh.wikipedia.org $server_name:3457 g;
            subs_filter zh.m.wikipedia.org $server_name:3458 g;
            subs_filter en.m.wikipedia.org $server_name:5005 g;
            subs_filter en.wikipedia.org $server_name:5004 g;
            #替换Logo链接
            subs_filter $google $server_name:$server_port g;
            subs_filter www.google.com $server_name:$server_port g;
            #替换文件类型
            subs_filter_types text/css text/xml text/javascript;
        }
    }

    #桌面版英文维基
    server {
        listen 5004 ssl;
        server_name 176.122.157.73;
        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;
        location / {
                #proxy_cache one;
                proxy_pass https://en.wikipedia.org;
                proxy_buffering off;
                proxy_cookie_domain en.wikipedia.org $server_name:$server_port;
                proxy_redirect https://en.wikipedia.org/ /;
                proxy_redirect https://en.m.wikipedia.org/ https://$server_name:5005/;
                proxy_set_header X-Real_IP $remote_addr;
                proxy_set_header User-Agent $http_user_agent;
                proxy_set_header Accept-Encoding &#34;&#34;;
                proxy_set_header referer &#34;https://en.wikipedia.org$request_uri&#34;;
                #替换手机版视图为代理
                subs_filter en.m.wikipedia.org $server_name:5005 g;
                subs_filter en.wikipedia.org $server_name:$server_port g;
                subs_filter zh.wikipedia.org $server_name:3457 g;
                subs_filter zh.m.wikipedia.org $server_name:3458 g;
        }
        location https://en.m.wikipedia.org/ {
                rewrite ^/(.*) https://$server_name:5005/$1 permanent;
        }
    }

    #移动版英文维基
    server {
        listen 5005 ssl;
        server_name 176.122.157.73;
        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location / {
            #proxy_cache one;
            proxy_pass https://en.m.wikipedia.org;
            proxy_buffering off;
            proxy_redirect https://en.m.wikipedia.org/ /;
            proxy_cookie_domain en.m.wikipedia.org $server_name:$server_port;
            proxy_set_header X-Real_IP $remote_addr;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Accept-Encoding &#34;&#34;;
            proxy_set_header referer https://en.m.wikipedia.org$request_uri;
            #替换桌面版视图为代理
            subs_filter en.wikipedia.org $server_name:5004 g;
            subs_filter en.m.wikipedia.org $server_name:$server_port g;
            subs_filter zh.wikipedia.org $server_name:3457 g;
            subs_filter zh.m.wikipedia.org $server_name:3458 g;
        }
    }

    # v2ray
    server {
        listen 53514 ssl;
        server_name 176.122.157.73;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_certificate cert/176.122.157.73.crt;
        ssl_certificate_key cert/176.122.157.73.key;

        location /9a00db84-636e-4653-b763-e0271e167b41 {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:53513;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection &#34;upgrade&#34;;
            proxy_set_header Host $http_host;

            # Show realip in v2ray access.log
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
</code></pre><div class="float-right mb-8"><p class="text-sm mb-4 font-gray-700 italic">(773 words)</p></div></article></div></main><hr><footer class="w-full text-center p-4 pin-b text-xs text-gray-400"><p>made with <a href=https://gohugo.io class="underline hover:text-blue-400">Hugo</a> and <a href=https://tailwindcss.com class="underline hover:text-blue-400">TailwindCSS</a></p></footer></body></html>