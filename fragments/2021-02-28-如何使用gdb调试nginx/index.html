<!doctype html><html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ğŸ”¦å¦‚ä½•ä½¿ç”¨GDBè°ƒè¯•Nginx</title><meta name=generator content="Hugo 0.112.3"><link rel=stylesheet href="https://zenuo.github.io/css/styles.min.da6e1927bcb6a0faebcb06ab9925c87524b8057860afacf48eab54fcbf9eef18.css" integrity="sha256-2m4ZJ7y2oPrrywarmSXIdSS4BXhgr6z0jqtU/L+e7xg="><script async defer data-domain=kaiwern.com src=https://plausible.io/js/plausible.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Lora&family=Source+Sans+Pro:wght@400;600&display=swap" rel=stylesheet><body class="flex flex-col min-h-screen px-6 max-w-prose md:w-2/3 m-auto"><nav class=mt-8><ul id=nav-menu class="w-full flex items-center list-reset"><li><a href=https://zenuo.github.io/>Home</a></li><li><a href=https://zenuo.github.io/fragments/>Fragments</a></li><li><a href=https://zenuo.github.io/about/>About</a></li><li><a href=https://zenuo.github.io/tags/>Tags</a></li></ul></nav><main class="flex-1 mt-10 sm:mt-12"><div><header class="mb-8 font-sans-serif"><div class="text-sm font-gray-700 mb-8"><p class="uppercase font-semibold"><a class=text-gray-700 href=/fragments>fragments</a></p><p>Feb 28, 2021</p></div><h1 class="text-3xl mb-1 font-semibold">ğŸ”¦å¦‚ä½•ä½¿ç”¨GDBè°ƒè¯•Nginx</h1><p class="italic text-xs">Last updated at: Feb 28, 2021</p></header><article class="prose serif mb-16 text-gray-800"><p>æœ¬æ–‡ä¸»è¦æè¿°åœ¨<code>CentOS 7</code>ä¸‹ï¼Œä½¿ç”¨<a href=https://www.gnu.org/s/gdb/>gdb</a>è°ƒè¯•Nginx</p><h1 id=1-å‡†å¤‡>1 å‡†å¤‡</h1><p>ä¸‹è½½nginxåŠå…¶ä¾èµ–é¡¹ç›®æºç ï¼Œå¹¶è§£å‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -OL https://mirrors.sohu.com/nginx/nginx-1.19.7.tar.gz
</span></span><span class=line><span class=cl>tar zxf nginx-1.19.7.tar.gz
</span></span><span class=line><span class=cl>curl -OL https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz
</span></span><span class=line><span class=cl>tar zxf pcre-8.44.tar.gz
</span></span><span class=line><span class=cl>curl -OL http://zlib.net/zlib-1.2.11.tar.gz
</span></span><span class=line><span class=cl>tar zxf zlib-1.2.11.tar.gz
</span></span></code></pre></div><p>å®‰è£…æ„å»ºå·¥å…·ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install gcc make
</span></span></code></pre></div><p>æ„å»ºnginx:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /opt/app/nginx-1.19.7
</span></span><span class=line><span class=cl>./configure --with-debug --with-cc-opt<span class=o>=</span><span class=s1>&#39;-O0 -g&#39;</span> --with-pcre<span class=o>=</span>/opt/app/pcre-8.44 --with-zlib<span class=o>=</span>/opt/app/zlib-1.2.11 --prefix<span class=o>=</span>/opt/app/nginx
</span></span><span class=line><span class=cl>make <span class=o>&amp;&amp;</span> make install
</span></span></code></pre></div><p>ä¿®æ”¹nginxé…ç½®æ–‡ä»¶<code>/opt/app/nginx/conf/nginx.conf</code>:</p><pre tabindex=0><code># æœ€å¥½æ˜¯1ï¼Œä¾¿äºæ–­ç‚¹è°ƒè¯•
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       8000;
        server_name  localhost;

        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
</code></pre><p>å¯åŠ¨ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/app/nginx/sbin/nginx
</span></span></code></pre></div><p>ä½¿ç”¨curlè®¿é—®:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v localhost:8080
</span></span></code></pre></div><p>è‹¥èƒ½è¿”å›<code>200 OK</code>ï¼Œåˆ™å·²å‡†å¤‡å¥½è°ƒè¯•ç¯å¢ƒ</p><h1 id=2-è°ƒè¯•>2 è°ƒè¯•</h1><p>å®‰è£…è°ƒè¯•å·¥å…·</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install gdb
</span></span></code></pre></div><p>æ‰¾åˆ°nginx workerçš„è¿›ç¨‹å·ï¼š</p><blockquote><p>ä¸ºä»€ä¹ˆæ˜¯<code>worker</code>è¿›ç¨‹å·å‘¢ï¼Ÿå› ä¸ºåœ¨nginxæ¶æ„ä¸­ï¼Œè¿›ç¨‹ç±»å‹ä¸»è¦æ˜¯<code>master</code>å’Œ<code>worker</code>ä¸¤ç±»ï¼Œå‰è€…ä¸»è¦è´Ÿè´£é…ç½®è§£æã€é‡è½½é…ç½®ã€ç»´æŠ¤workè¿›ç¨‹ç»„ç­‰èŒè´£ï¼Œè€Œåè€…æ‰æ˜¯æ¥æ”¶ã€å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ã€‚æ›´å¤š<a href=2019/01/31/nginx%E6%9E%B6%E6%9E%84.html>ç§»æ­¥</a></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ps -ef <span class=p>|</span> grep <span class=s1>&#39;nginx: worker process&#39;</span> <span class=p>|</span> grep -v grep
</span></span></code></pre></div><p>ä¾‹å¦‚:</p><pre tabindex=0><code>[newad@localhost nginx]$ ps -ef | grep &#39;nginx: worker process&#39; | grep -v grep
newad    12362 12361  0 17:55 ?        00:00:00 nginx: worker process
</code></pre><p>å¯çŸ¥è¿›ç¨‹å·æ˜¯<code>12362</code></p><p>ç”¨gdbè¿æ¥ä¸Šnginx workerè¿›ç¨‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gdb -p <span class=m>12362</span>
</span></span></code></pre></div><p>è‹¥è¾“å‡ºçš„æœ«å°¾æ˜¯<code>(gdb)</code>å­—æ ·ï¼Œåˆ™è¿æ¥æˆåŠŸ</p><p>åœ¨æ–‡ä»¶<code>ngx_http_core_module.c</code>çš„<code>1816</code>è¡Œè®¾ç½®æ–­ç‚¹ï¼š</p><pre tabindex=0><code>(gdb) break src/http/ngx_http_core_module.c:1816
Breakpoint 1 at 0x4d4944: file src/http/ngx_http_core_module.c, line 1816.
</code></pre><p>ç»§ç»­è¿è¡Œè¿›ç¨‹ï¼š</p><pre tabindex=0><code>(gdb) continue
Continuing.
</code></pre><p>æ–°å¼€ä¸€ä¸ªsshä¼šè¯ï¼Œä½¿ç”¨curlå‘èµ·è®¿é—®ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v localhost:8080
</span></span></code></pre></div><p>å›åˆ°gdbçš„ä¼šè¯ï¼Œå¯ä»¥å‘ç°ç¨‹åºåœ¨åˆšåˆšè®¾ç½®çš„æ–­ç‚¹åœä½äº†ï¼š</p><pre tabindex=0><code>Breakpoint 1, ngx_http_send_header (r=0x1f7db20) at src/http/ngx_http_core_module.c:1816
1816	    if (r-&gt;post_action) {
</code></pre><p>å¯ä»¥é€šè¿‡ç»„åˆé”®<code>ctrl x</code>å’Œ<code>ctrl a</code>è¿›å…¥<a href=http://www.cs.fsu.edu/~baker/ada/gnat/html/gdb_23.html>TUIæ¨¡å¼</a>ï¼Œå®ç°åŒæ—¶æŸ¥çœ‹æºä»£ç å’Œæ§åˆ¶å°ï¼Œå¦‚å›¾ï¼š</p><p><img src=/img/a8287077f7adc3f2f39b8f2b.png alt=a8287077f7adc3f2f39b8f2b.png></p><p>ä½¿ç”¨<code>p</code>å‘½ä»¤ï¼Œæ±‚å€¼ï¼ˆæ‰“å°ï¼‰è¡¨è¾¾å¼ï¼š</p><pre tabindex=0><code>(gdb) p r-&gt;request_line
$2 = {len = 14, data = 0x1f844d8 &#34;GET / HTTP/1.1\r\nHost&#34;}
</code></pre><p>ä½¿ç”¨<code>ptype</code>å‘½ä»¤ï¼Œæ‰“å°structæˆ–è€…classçš„å®šä¹‰ï¼š</p><pre tabindex=0><code>(gdb) ptype ngx_http_request_body_t
type = struct {
    ngx_temp_file_t *temp_file;
    ngx_chain_t *bufs;
    ngx_buf_t *buf;
    off_t rest;
    off_t received;
    ngx_chain_t *free;
    ngx_chain_t *busy;
    ngx_http_chunked_t *chunked;
    ngx_http_client_body_handler_pt post_handler;
}
</code></pre><p>ä½¿ç”¨<code>continue</code>å‘½ä»¤ï¼Œç»§ç»­è¿è¡Œè¿›ç¨‹ã€‚</p><h1 id=3-å‚è€ƒ>3 å‚è€ƒ</h1><ul><li><a href=http://www.cs.fsu.edu/~baker/ada/gnat/html/gdb_23.html>http://www.cs.fsu.edu/~baker/ada/gnat/html/gdb_23.html</a></li><li><a href=https://stackoverflow.com/questions/10115540/gdb-split-view-with-code>https://stackoverflow.com/questions/10115540/gdb-split-view-with-code</a></li><li><a href=https://docs.nginx.com/nginx/admin-guide/monitoring/debugging/#nginx-and-debugging-symbols>https://docs.nginx.com/nginx/admin-guide/monitoring/debugging/#nginx-and-debugging-symbols</a></li><li><a href=https://stackoverflow.com/questions/1768620/how-do-i-show-what-fields-a-struct-has-in-gdb>https://stackoverflow.com/questions/1768620/how-do-i-show-what-fields-a-struct-has-in-gdb</a></li></ul><div class="float-right mb-8"><p class="text-sm mb-4 font-gray-700 italic">(234 words)</p></div></article></div></main><hr><footer class="w-full text-center p-4 pin-b text-xs text-gray-400"><p>made with <a href=https://gohugo.io class="underline hover:text-blue-400">Hugo</a> and <a href=https://tailwindcss.com class="underline hover:text-blue-400">TailwindCSS</a></p></footer></body></html>