<!doctype html><html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>åŸºäºredsocks2å’Œpfçš„macOSé€æ˜ä»£ç†</title><meta name=generator content="Hugo 0.112.3"><link rel=stylesheet href="https://zenuo.github.io/css/styles.min.da6e1927bcb6a0faebcb06ab9925c87524b8057860afacf48eab54fcbf9eef18.css" integrity="sha256-2m4ZJ7y2oPrrywarmSXIdSS4BXhgr6z0jqtU/L+e7xg="><script async defer data-domain=kaiwern.com src=https://plausible.io/js/plausible.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Lora&family=Source+Sans+Pro:wght@400;600&display=swap" rel=stylesheet><body class="flex flex-col min-h-screen px-6 max-w-prose md:w-2/3 m-auto"><nav class=mt-8><ul id=nav-menu class="w-full flex items-center list-reset"><li><a href=https://zenuo.github.io/>Home</a></li><li><a href=https://zenuo.github.io/fragments/>Fragments</a></li><li><a href=https://zenuo.github.io/about/>About</a></li><li><a href=https://zenuo.github.io/tags/>Tags</a></li></ul></nav><main class="flex-1 mt-10 sm:mt-12"><div><header class="mb-8 font-sans-serif"><div class="text-sm font-gray-700 mb-8"><p class="uppercase font-semibold"><a class=text-gray-700 href=/fragments>fragments</a></p><p>Sep 04, 2022</p></div><h1 class="text-3xl mb-1 font-semibold">åŸºäºredsocks2å’Œpfçš„macOSé€æ˜ä»£ç†</h1><p class="italic text-xs">Last updated at: Sep 04, 2022</p></header><article class="prose serif mb-16 text-gray-800"><p>å‘ç‚¹ï¼šåœ¨[ğŸ§°EasyConnect in Dokcer](../2021-05-01-ğŸ§°EasyConnect in Dokcer/)ä¸­è®°å½•äº†åœ¨å®¹å™¨ä¸­è¿è¡ŒSangfor EasyConnectçš„æ­¥éª¤ï¼Œå¹¶é€šè¿‡socks5ä»£ç†æ¥å®ç°VPNä½¿ç”¨ï¼Œä½†è¿™ç§æ–¹å¼å…·æœ‰ä¸€äº›å±€é™æ€§ï¼Œä»…å¯¹æ”¯æŒäº†socks5æˆ–httpä»£ç†çš„ç¨‹åºæœ‰ç”¨ã€‚ä¸¾ä¸€ä¸ªä¸æ”¯æŒçš„ä¾‹å­ï¼šæˆ‘åœ¨æœ¬åœ°æ‰§è¡ŒJavaå·¥ç¨‹çš„å•å…ƒæµ‹è¯•æ—¶ï¼Œå•å…ƒæµ‹è¯•ä¸­æœ‰è®¿é—®zkçš„é€»è¾‘ï¼Œå°½ç®¡åœ¨JVMå‚æ•°ä¸­æ·»åŠ äº†<code>-DsocksProxySet=true -DsocksProxyHost=alpine -DsocksProxyPort=1080</code>ï¼Œä½†å¯¹è®¿é—®zkåº•å±‚çš„nioæ¥è¯´æ˜¯æ— æ•ˆçš„ğŸ˜¢</p><p>è¿˜å¥½åœ¨æœç´¢åˆ°äº†è¿™ä¸¤ç¯‡æ–‡ç« ï¼Œå‘ç°å¯ä»¥é€šè¿‡é€æ˜ä»£ç†æ¥æ”¯æŒè¿™ç§åœºæ™¯ï¼š</p><ul><li><a href=https://luckypoem.blog.fc2.com/blog-entry-738.html>macosä½¿ç”¨redsocksåšé€æ˜ä»£ç†</a></li><li><a href=https://penglei.github.io/post/transparent_proxy_on_macosx/#_a_%E9%85%8D%E7%BD%AEpf_conf>macOS é€æ˜ä»£ç†é…ç½®</a></li></ul><p>ä¸‹é¢æ˜¯æˆ‘çš„æ“ä½œæ­¥éª¤</p><h1 id=1-ç¼–è¯‘é…ç½®redsocks>1 ç¼–è¯‘ã€é…ç½®redsocks</h1><pre tabindex=0><code>$ wget https://github.com/HaoH/redsocks/archive/release-0.68.tar.gz # ä¸‹è½½æºç 
$ tar -zxvf redsocks-release-0.68.tar.gz # è§£å‹ç¼©
$ cd redsocks-release-0.68
</code></pre><p>åœ¨æˆ‘çš„ç”µè„‘ç¯å¢ƒä¸­ï¼ŒæŒ‰ç…§æºç åŒ…çš„ä»£ç æ„å»ºçš„ç»“æœï¼Œè¿è¡Œæ—¶ä¼šæŠ¥é”™ï¼š</p><pre tabindex=0><code>1662282301.374137 err redsocks.c:693 redsocks_connect_relay(...) [192.168.0.103:54303-&gt;10.100.*.*:80]: red_connect_relay failed!!!: Protocol not available
1662282301.375292 err utils.c:154 red_prepare_relay(...) setsockopt: Protocol not available
</code></pre><p>å¯ä»¥çœ‹åˆ°æŠ¥é”™åœ¨<code>utils.c:154</code>ï¼Œç»æŸ¥é˜…<a href="https://git.kernel.dk/cgit/fio/commit/?id=8a768c2e725d6a527b904570949f6099c3f1434a">èµ„æ–™</a>ï¼Œæ­¤ç§æŠ¥é”™å¯ä»¥è¢«å¿½ç•¥ï¼Œæ‰€ä»¥ä¿®æ”¹ä»£ç ï¼š</p><pre tabindex=0><code>$ vim utils.c
</code></pre><p>å°†153è‡³156è¡Œæ³¨é‡Šï¼Œå¿½ç•¥setsocketoptçš„æŠ¥é”™ï¼š</p><pre tabindex=0><code>        // if (error) {
        //     log_errno(LOG_ERR, &#34;setsockopt&#34;);
        //     goto fail;
        // }
</code></pre><pre tabindex=0><code>$ https_proxy=socks5://localhost:1080 make OSX_VERSION=master DISABLE_SHADOWSOCKS=true # æ„å»º
$ vim redsocks.conf
</code></pre><p>å†…å®¹å¦‚ä¸‹ï¼š</p><pre tabindex=0><code>base {
	log_debug = off;
	log_info = on;
	log = stderr;
	daemon = off;
	redirector = pf;
	reuseport = off;
}

redsocks {
    // redsocksçš„ç›‘å¬çš„åœ°å€å’Œç«¯å£
	bind = &#34;127.0.0.1:12345&#34;;
    // ä»£ç†çš„åœ°å€å’Œç«¯å£
	relay = &#34;192.168.17.128:1080&#34;;
	type = socks5;
	autoproxy = 0;
	timeout = 10;
}
</code></pre><h1 id=2-é…ç½®pf>2 é…ç½®pf</h1><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰å‡ºéœ€è¦è½¬å‘åˆ°ä»£ç†çš„cidrè¡¨ï¼Œå­˜æ”¾åˆ°æ–‡ä»¶<code>/opt/app/redsocks/forward_cidr.txt</code>ï¼Œè‹¥éœ€è¦è½¬å‘<code>10.100.0.0/16</code>å’Œ<code>10.1.0.0/16</code>ç½‘æ®µçš„IPåˆ°ä»£ç†ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre tabindex=0><code>10.100.0.0/16
10.1.0.0/16
</code></pre><p>ç¼–è¾‘<code>/etc/pf.conf</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre tabindex=0><code>scrub-anchor &#34;com.apple/*&#34;

table &lt;forward_cidr&gt; persist file &#34;/opt/app/redsocks/forward_cidr.txt&#34;

nat-anchor &#34;com.apple/*&#34;

rdr-anchor &#34;com.apple/*&#34;
rdr pass on lo0 proto tcp from any to &lt;forward_cidr&gt; -&gt; 127.0.0.1 port 12345

pass out route-to (lo0 127.0.0.1) proto tcp from any to &lt;forward_cidr&gt;

dummynet-anchor &#34;com.apple/*&#34;

anchor &#34;com.apple/*&#34;
load anchor &#34;com.apple&#34; from &#34;/etc/pf.anchors/com.apple&#34;
</code></pre><h2 id=3-è¿è¡Œ>3 è¿è¡Œ</h2><p>å¯åŠ¨çš„è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><pre tabindex=0><code># å¯åŠ¨pf
sudo sysctl -w net.inet.ip.forwarding=1
sudo pfctl -e
sudo pfctl -F all
sudo pfctl -f /etc/pf.conf

# å¯åŠ¨redsocks
sudo ./redsocks2 -c ./redsocks.conf
</code></pre><p>ä½¿ç”¨ä»£ç†å®Œæˆä¹‹åï¼Œä½ å¯ä»¥Ctrl+Cå…³é—­redsocksï¼Œç„¶åç”¨ä¸‹é¢çš„è„šæœ¬å…³é—­pf:</p><pre tabindex=0><code># å…³é—­pf
sudo pfctl -d
sudo pfctl -F all
</code></pre><div class="float-right mb-8"><p class="text-sm mb-4 font-gray-700 italic">(206 words)</p></div></article></div></main><hr><footer class="w-full text-center p-4 pin-b text-xs text-gray-400"><p>made with <a href=https://gohugo.io class="underline hover:text-blue-400">Hugo</a> and <a href=https://tailwindcss.com class="underline hover:text-blue-400">TailwindCSS</a></p></footer></body></html>