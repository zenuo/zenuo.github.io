---
title: "ðŸ§¯è®°ä¸€æ¬¡çŽ¯å¢ƒå˜é‡å¯¼è‡´çš„ä¸­æ–‡ä¹±ç "
date: 2020-06-14T19:23:13+08:00
categories: ["tech"]
---

## ä¸€ã€çŽ°è±¡

1. ä½¿ç”¨æœ¬åœ°`ssh`è®¿é—®æœåŠ¡å™¨
2. é‡å¯åº”ç”¨
3. `æŸ¥è¯¢ä¸»æ•°æ®å•†å“ä¿¡æ¯`çš„å†…å®¹ä¸­æ–‡ä¹±ç 
4. `jinfo`å‘½ä»¤è¾“å‡º`file.encoding = ANSI_X3.4-1968`
5. ä½¿ç”¨`Xshell`è®¿é—®æœåŠ¡å™¨
6. é‡å¯åº”ç”¨
7. `jinfo`å‘½ä»¤è¾“å‡º`file.encoding = UTF-8`
8. `æŸ¥è¯¢ä¸»æ•°æ®å•†å“ä¿¡æ¯`çš„å†…å®¹ä¸­æ–‡æ¢å¤æ­£å¸¸

## äºŒã€ä¸ºä»€ä¹ˆä¹±ç 

### çŒœæƒ³

åˆæ­¥çŒœæƒ³æ˜¯`æœ¬åœ°ssh`å’Œ`Xshell`çš„`sshä¼šè¯`çš„`locale`ä¼šè¯ä¸åŒï¼Œå¯¼è‡´é‡å¯åŽçš„`JVMé»˜è®¤å­—ç¬¦é›†`çš„ä¸åŒå¯¼è‡´äº†ä¹±ç ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¥éªŒè¯ï¼š

``` java
import java.nio.charset.Charset;

public class Main {
    public static void main(String[] args) {
        System.out.println(System.getProperty("file.encoding"));
        System.out.println(Charset.defaultCharset());
    }
}
```

> æ€è·¯ï¼šåˆ†åˆ«ä½¿ç”¨`æœ¬åœ°ssh`å’Œ`Xshell`è®¿é—®æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹localeå¹¶æ‰§è¡Œä»£ç ç‰‡æ®µ

ä½¿ç”¨`æœ¬åœ°ssh`è®¿é—®ï¼š

``` bash
[æœåŠ¡å™¨ ~]$ locale
locale: Cannot set LC_CTYPE to default locale: No such file or directory # å¼‚å¸¸ä¿¡æ¯
locale: Cannot set LC_ALL to default locale: No such file or directory   # å¼‚å¸¸ä¿¡æ¯
LANG=en_US.UTF-8
LC_CTYPE=UTF-8
LC_NUMERIC="en_US.UTF-8"
LC_TIME="en_US.UTF-8"
LC_COLLATE="en_US.UTF-8"
LC_MONETARY="en_US.UTF-8"
LC_MESSAGES="en_US.UTF-8"
LC_PAPER="en_US.UTF-8"
LC_NAME="en_US.UTF-8"
LC_ADDRESS="en_US.UTF-8"
LC_TELEPHONE="en_US.UTF-8"
LC_MEASUREMENT="en_US.UTF-8"
LC_IDENTIFICATION="en_US.UTF-8"
LC_ALL=
[æœåŠ¡å™¨ ~]$ java Main
ANSI_X3.4-1968
US-ASCII
```

å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶JVMå±žæ€§`file.encoding`çš„å€¼ä¸º`ANSI_X3.4-1968`ï¼Œé»˜è®¤å­—ç¬¦é›†ä¸º`US-ASCII`ï¼›

ä½¿ç”¨`Xshell`è®¿é—®ï¼š

``` bash
[æœåŠ¡å™¨ ~]$ locale
# æ²¡æœ‰å¼‚å¸¸ä¿¡æ¯
LANG=en_US.UTF-8
LC_CTYPE="en_US.UTF-8"
LC_NUMERIC="en_US.UTF-8"
LC_TIME="en_US.UTF-8"
LC_COLLATE="en_US.UTF-8"
LC_MONETARY="en_US.UTF-8"
LC_MESSAGES="en_US.UTF-8"
LC_PAPER="en_US.UTF-8"
LC_NAME="en_US.UTF-8"
LC_ADDRESS="en_US.UTF-8"
LC_TELEPHONE="en_US.UTF-8"
LC_MEASUREMENT="en_US.UTF-8"
LC_IDENTIFICATION="en_US.UTF-8"
LC_ALL=
[æœåŠ¡å™¨ ~]$ java Main
UTF-8
UTF-8
```

å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶JVMå±žæ€§`file.encoding`çš„å€¼ä¸º`UTF-8`ï¼Œé»˜è®¤å­—ç¬¦é›†ä¸º`UTF-8`ï¼›

### åˆ°ä»£ç ä¸­éªŒè¯çŒœæƒ³

ä¹±ç çš„æŽ¥å£æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

``` java
try {
    result = httpClient.execute(request);
} catch (Exception e) {
    throw new RuntimeException("æŸ¥è¯¢å¼‚å¸¸",e);
}
```

`httpclient`æ‰§è¡ŒHTTPè¯·æ±‚ï¼Œexecuteæ–¹æ³•ä»£ç ï¼š

``` java
if("POST".equals(reqType)){
    responseStr = new String(this.doHttpPost(reqParams, serverUrl)); // æ³¨æ„ç‚¹1ï¼šæŸ¥è¯¢ä¸»æ•°æ®å•†å“ä¿¡æ¯ï¼Œä»£ç ä¼šæ‰§è¡Œæ­¤è¡Œ
}else if ("GET".equals(reqType)){
    responseStr = new String(this.doHttpGet(reqParams,serverUrl));
}
```

`æ³¨æ„ç‚¹1`è¿™è¡Œä»£ç ï¼Œé€šè¿‡è°ƒç”¨`doHttpPost`æ–¹æ³•ï¼š

``` java
URIBuilder uriBuilder = new URIBuilder(serverUrl);
HttpPost httpPost = new HttpPost(uriBuilder.build());
httpPost.setHeader("Accept", "application/json;charset=utf-8"); // æ³¨æ„ç‚¹2ï¼šå¤´éƒ¨AcceptæŒ‡å®šäº†æŽ¥å—çš„å“åº”å­—ç¬¦é›†ä¸ºutf-8ï¼Œä½†HTTPåè®®å¹¶æœªå¼ºåˆ¶æœåŠ¡ç«¯è¦æ ¹æ®Acceptçš„å­—ç¬¦é›†æ¥å“åº”ï¼Œæ‰€ä»¥éœ€è¦å…¶ä»–æ–¹æ³•æ¥åˆ¤æ–­å“åº”çš„å­—ç¬¦é›†
httpPost.setHeader("Content-Type", "application/json;charset=utf-8");
this.addHeader(httpPost);
StringEntity postingString = new StringEntity(JSONObject.toJSONString(params), "utf-8");
httpPost.setEntity(postingString);
return getEntityAndRelease(httpPost);
```

> æŽ¥ä¸‹æ¥åœ¨å¼€å‘çŽ¯å¢ƒï¼Œé€šè¿‡æ”¹å˜å¤´éƒ¨`Accept`çš„`charset`ï¼Œæ·»åŠ JVMå‚æ•°`-Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.SimpleLog -Dorg.apache.commons.logging.simplelog.log.org.apache.http=DEBUG`ï¼Œè§‚å¯ŸHTTPå“åº”çš„å¤´éƒ¨`Content-Type`çš„æ–¹å¼æ¥åˆ¤æ–­å“åº”çš„ç¼–ç 

- charsetè®¾ç½®ä¸ºutf-8æ—¶ï¼Œæ—¥å¿—ä¸ºï¼š

```
[DEBUG] wire - http-outgoing-0 >> "POST /winshare-center-gateway/api/item/v1/item/ec/4435922 HTTP/1.1[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Accept: application/json;charset=utf-8[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Content-Type: application/json;charset=utf-8[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Content-Length: 14[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Host: 10.100.9.202:8607[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Connection: Keep-Alive[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Accept-Encoding: gzip,deflate[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "{"id":4435922}"
[DEBUG] wire - http-outgoing-0 << "HTTP/1.1 503 Service Unavailable[\r][\n]"
[DEBUG] wire - http-outgoing-0 << "Content-Type: application/json;charset=UTF-8[\r][\n]"
[DEBUG] wire - http-outgoing-0 << "Content-Length: 186[\r][\n]"
[DEBUG] wire - http-outgoing-0 << "[\r][\n]"
```

- charsetè®¾ç½®ä¸ºgb18030æ—¶ï¼Œæ—¥å¿—ä¸ºï¼š

```
[DEBUG] wire - http-outgoing-0 >> "POST /winshare-center-gateway/api/item/v1/item/ec/4435922 HTTP/1.1[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Accept: application/json;charset=gb18030[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Content-Type: application/json;charset=utf-8[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Content-Length: 14[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Connection: Keep-Alive[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "Accept-Encoding: gzip,deflate[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "[\r][\n]"
[DEBUG] wire - http-outgoing-0 >> "{"id":4435922}"
[DEBUG] wire - http-outgoing-0 << "HTTP/1.1 503 Service Unavailable[\r][\n]"
[DEBUG] wire - http-outgoing-0 << "Content-Type: application/json;charset=UTF-8[\r][\n]"
[DEBUG] wire - http-outgoing-0 << "Content-Length: 186[\r][\n]"
[DEBUG] wire - http-outgoing-0 << "[\r][\n]"
```

é€šè¿‡æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬å‘çŽ°å“åº”çš„å­—ç¬¦é›†éƒ½æ˜¯UTF-8ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–¹æ³•è¿”å›žçš„å­—èŠ‚æ•°ç»„åº”è¯¥è¢«UTF-8è§£ç ï¼›

å›žåˆ°`æ³¨æ„ç‚¹1`ï¼Œæ­¤å¤„ä½¿ç”¨äº†æž„é€ æ–¹æ³•`java.lang.String#String(byte[])`åˆ›å»ºStringå®žä¾‹ï¼Œæ­¤æž„é€ æ–¹æ³•ä½¿ç”¨é»˜è®¤å­—ç¬¦é›†è§£ç å­—èŠ‚æ•°ç»„ï¼Œä½¿ç”¨`æœ¬åœ°ssh`é‡å¯åŽï¼Œé»˜è®¤å­—ç¬¦é›†ä¸º`US-ASCII`ï¼Œè€Œä¸æ˜¯`UTF-8`ï¼Œè¿™æ˜¯æ­¤æ¬¡å‘ç”Ÿä¹±ç çš„ç¼–ç åŽŸå› ã€‚

## ä¸‰ã€ä¸ºä»€ä¹ˆæœ¬åœ°sshä¸ŽXshellè¡¨çŽ°ä¸åŒ

æŸ¥èµ„æ–™å¾—çŸ¥ï¼Œæœ¬åœ°`/etc/ssh/ssh_config`å«æœ‰`SendEnv LANG LC_*`ï¼Œæ­¤é€‰é¡¹æŒ‡æ˜Žäº†åˆ›å»ºsshä¼šè¯æ—¶ï¼Œå°†æœ¬åœ°çš„`LANG`å’Œ`LC_*`çŽ¯å¢ƒå˜é‡å‘é€åˆ°æœåŠ¡ç«¯ï¼Œä½¿å¾—åˆ›å»ºçš„sshä¼šè¯ä½¿ç”¨æœ¬åœ°çš„`LANG`å’Œ`LC_*`çŽ¯å¢ƒå˜é‡ï¼›

ä½†æ˜¯æœ¬åœ°çš„è¿™äº›å˜é‡çš„å€¼æ˜¯ï¼š

``` bash
[æœ¬åœ° ~]$ locale
LANG=""
LC_COLLATE="C"
LC_CTYPE="UTF-8"
LC_MESSAGES="C"
LC_MONETARY="C"
LC_NUMERIC="C"
LC_TIME="C"
LC_ALL=
```

è¿˜è®°å¾—æœ¬åœ°sshè®¿é—®æœåŠ¡å™¨æ‰§è¡Œ`locale`æ—¶çš„è¿™ä¸¤è¡ŒæŠ¥é”™å—ï¼Ÿ

```
locale: Cannot set LC_CTYPE to default locale: No such file or directory
locale: Cannot set LC_ALL to default locale: No such file or directory
```

è¯´æ˜Žå½“å‰çš„æœåŠ¡å™¨é…ç½®æ˜¯ä¸æ”¯æŒ`LC_CTYPE="UTF-8"`å’Œ`LC_ALL=`çš„ï¼Œä½†æœªå¼•èµ·é‡è§†ï¼Œä¸€ç›´é€‰æ‹©çš„å¿½ç•¥ï¼›è§£å†³åŠžæ³•æ˜¯ï¼šæ³¨é‡Šæœ¬åœ°çš„`/etc/ssh/ssh_config`ä¸­çš„`SendEnv LANG LC_*`

## å››ã€å¾—åˆ°çš„æ•™è®­

1. sshè®¿é—®æœåŠ¡å™¨æ—¶ï¼Œä¸è¦ä½¿ç”¨æœ¬åœ°çš„localeè®¾ç½®ï¼Œé¿å…æœ¬åœ°çŽ¯å¢ƒå½±å“æœåŠ¡å™¨
2. å¯åŠ¨åº”ç”¨æ—¶é€šè¿‡JVMæŒ‡å®šæ–‡ä»¶ç¼–ç ï¼ˆ`-Dfile.encoding=UTF-8`ï¼‰ï¼ŒæŽ’é™¤å¯åŠ¨çš„`sshä¼šè¯`å¯¹åº”ç”¨çš„æ–‡ä»¶ç¼–ç çš„å½±å“
3. ç¼–ç æ—¶ä¸è¦å‡å®šä»»ä½•çš„çŽ¯å¢ƒå˜é‡ï¼šè§£ç å­—èŠ‚æ•°ç»„æ—¶ï¼ŒæŒ‡å®šå­—ç¬¦é›†ï¼Œä¸ä½¿ç”¨é»˜è®¤å­—ç¬¦é›†

## äº”ã€å‚è€ƒ

1 [Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content](https://tools.ietf.org/html/rfc7231#section-5.3.3)
2 [String ( Java SE 11 & JDK 11 )](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/String.html#%3Cinit%3E(byte%5B%5D))
3 [man 5 ssh_config](https://linux.die.net/man/5/ssh_config)
