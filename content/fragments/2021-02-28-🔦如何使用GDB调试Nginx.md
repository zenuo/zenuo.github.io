---
title: "ğŸ”¦å¦‚ä½•ä½¿ç”¨GDBè°ƒè¯•Nginx"
date: 2021-02-28T19:23:13+08:00
categories: ["tech"]
---

æœ¬æ–‡ä¸»è¦æè¿°åœ¨`CentOS 7`ä¸‹ï¼Œä½¿ç”¨[gdb](https://www.gnu.org/s/gdb/)è°ƒè¯•Nginx

# 1 å‡†å¤‡

ä¸‹è½½nginxåŠå…¶ä¾èµ–é¡¹ç›®æºç ï¼Œå¹¶è§£å‹ï¼š

```bash
curl -OL https://mirrors.sohu.com/nginx/nginx-1.19.7.tar.gz
tar zxf nginx-1.19.7.tar.gz
curl -OL https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz
tar zxf pcre-8.44.tar.gz
curl -OL http://zlib.net/zlib-1.2.11.tar.gz
tar zxf zlib-1.2.11.tar.gz
```

å®‰è£…æ„å»ºå·¥å…·ï¼š

```bash
yum install gcc make
```

æ„å»ºnginx:

```bash
cd /opt/app/nginx-1.19.7
./configure --with-debug --with-cc-opt='-O0 -g' --with-pcre=/opt/app/pcre-8.44 --with-zlib=/opt/app/zlib-1.2.11 --prefix=/opt/app/nginx
make && make install
```

ä¿®æ”¹nginxé…ç½®æ–‡ä»¶`/opt/app/nginx/conf/nginx.conf`:

```
# æœ€å¥½æ˜¯1ï¼Œä¾¿äºæ–­ç‚¹è°ƒè¯•
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       8000;
        server_name  localhost;

        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

å¯åŠ¨ï¼š

```bash
/opt/app/nginx/sbin/nginx
```

ä½¿ç”¨curlè®¿é—®:

```bash
curl -v localhost:8080
```

è‹¥èƒ½è¿”å›`200 OK`ï¼Œåˆ™å·²å‡†å¤‡å¥½è°ƒè¯•ç¯å¢ƒ

# 2 è°ƒè¯•

å®‰è£…è°ƒè¯•å·¥å…·

```bash
yum install gdb
```

æ‰¾åˆ°nginx workerçš„è¿›ç¨‹å·ï¼š

> ä¸ºä»€ä¹ˆæ˜¯`worker`è¿›ç¨‹å·å‘¢ï¼Ÿå› ä¸ºåœ¨nginxæ¶æ„ä¸­ï¼Œè¿›ç¨‹ç±»å‹ä¸»è¦æ˜¯`master`å’Œ`worker`ä¸¤ç±»ï¼Œå‰è€…ä¸»è¦è´Ÿè´£é…ç½®è§£æã€é‡è½½é…ç½®ã€ç»´æŠ¤workè¿›ç¨‹ç»„ç­‰èŒè´£ï¼Œè€Œåè€…æ‰æ˜¯æ¥æ”¶ã€å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ã€‚æ›´å¤š[ç§»æ­¥](2019/01/31/nginxæ¶æ„.html)

```bash
ps -ef | grep 'nginx: worker process' | grep -v grep
```

ä¾‹å¦‚:

```
[newad@localhost nginx]$ ps -ef | grep 'nginx: worker process' | grep -v grep
newad    12362 12361  0 17:55 ?        00:00:00 nginx: worker process
```

å¯çŸ¥è¿›ç¨‹å·æ˜¯`12362`

ç”¨gdbè¿æ¥ä¸Šnginx workerè¿›ç¨‹ï¼š

```bash
gdb -p 12362
```

è‹¥è¾“å‡ºçš„æœ«å°¾æ˜¯`(gdb)`å­—æ ·ï¼Œåˆ™è¿æ¥æˆåŠŸ

åœ¨æ–‡ä»¶`ngx_http_core_module.c`çš„`1816`è¡Œè®¾ç½®æ–­ç‚¹ï¼š

```
(gdb) break src/http/ngx_http_core_module.c:1816
Breakpoint 1 at 0x4d4944: file src/http/ngx_http_core_module.c, line 1816.
```

ç»§ç»­è¿è¡Œè¿›ç¨‹ï¼š

```
(gdb) continue
Continuing.
```

æ–°å¼€ä¸€ä¸ªsshä¼šè¯ï¼Œä½¿ç”¨curlå‘èµ·è®¿é—®ï¼š

```bash
curl -v localhost:8080
```

å›åˆ°gdbçš„ä¼šè¯ï¼Œå¯ä»¥å‘ç°ç¨‹åºåœ¨åˆšåˆšè®¾ç½®çš„æ–­ç‚¹åœä½äº†ï¼š

```
Breakpoint 1, ngx_http_send_header (r=0x1f7db20) at src/http/ngx_http_core_module.c:1816
1816	    if (r->post_action) {
```

å¯ä»¥é€šè¿‡ç»„åˆé”®`ctrl x`å’Œ`ctrl a`è¿›å…¥[TUIæ¨¡å¼](http://www.cs.fsu.edu/~baker/ada/gnat/html/gdb_23.html)ï¼Œå®ç°åŒæ—¶æŸ¥çœ‹æºä»£ç å’Œæ§åˆ¶å°ï¼Œå¦‚å›¾ï¼š

![a8287077f7adc3f2f39b8f2b.png](assets/img/a8287077f7adc3f2f39b8f2b.png)

ä½¿ç”¨`p`å‘½ä»¤ï¼Œæ±‚å€¼ï¼ˆæ‰“å°ï¼‰è¡¨è¾¾å¼ï¼š

```
(gdb) p r->request_line
$2 = {len = 14, data = 0x1f844d8 "GET / HTTP/1.1\r\nHost"}
```

ä½¿ç”¨`ptype`å‘½ä»¤ï¼Œæ‰“å°structæˆ–è€…classçš„å®šä¹‰ï¼š

```
(gdb) ptype ngx_http_request_body_t
type = struct {
    ngx_temp_file_t *temp_file;
    ngx_chain_t *bufs;
    ngx_buf_t *buf;
    off_t rest;
    off_t received;
    ngx_chain_t *free;
    ngx_chain_t *busy;
    ngx_http_chunked_t *chunked;
    ngx_http_client_body_handler_pt post_handler;
}
```

ä½¿ç”¨`continue`å‘½ä»¤ï¼Œç»§ç»­è¿è¡Œè¿›ç¨‹ã€‚

# 3 å‚è€ƒ

- http://www.cs.fsu.edu/~baker/ada/gnat/html/gdb_23.html
- https://stackoverflow.com/questions/10115540/gdb-split-view-with-code
- https://docs.nginx.com/nginx/admin-guide/monitoring/debugging/#nginx-and-debugging-symbols
- https://stackoverflow.com/questions/1768620/how-do-i-show-what-fields-a-struct-has-in-gdb
